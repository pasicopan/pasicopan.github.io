<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>pasico 的idea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="pasico 的idea">
<meta property="og:url" content="http://paisco.cn/index.html">
<meta property="og:site_name" content="pasico 的idea">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="pasico 的idea">
  
    <link rel="alternate" href="/atom.xml" title="pasico 的idea" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>


  <body>
    <div id="container">
      <div id="wrap">
        <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">pasico 的idea</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://paisco.cn"></form>
      </div>
    </div>
  </div>
</header>
          <div class="outer">
            <section id="main">
              
  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/08/hello-world.html" class="article-date">
  <time datetime="2019-05-08T01:20:05.907Z" itemprop="datePublished">2019-05-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/08/hello-world.html">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
      <h3>原创文章，转载必须声明出处!</h3>
    </div>
    <footer class="article-footer">
      <a data-url="http://paisco.cn/2019/05/08/hello-world.html" data-id="cjvejigzj0009z4uidd4gic4l" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-compress-scroll-data" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/18/compress-scroll-data.html" class="article-date">
  <time datetime="2019-02-18T02:11:48.000Z" itemprop="datePublished">2019-02-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/18/compress-scroll-data.html">压缩页面滚动坐标的数据</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>思考一下如何更好记录用户滚动页面的数据。  </p>
<ul>
<li>一个“高度是H=N（N&lt;10)个屏幕高”手机网页为例，滚动范围大概是0~(N-1)*1000px</li>
<li>每个坐标需要S 个字符保存，0~(N-1)*1000px 就是 4个字符来保存</li>
<li>onscroll 每秒触发F次</li>
<li>每M 秒上传一次数据到服务器</li>
<li>页面有P 万人打开</li>
<li>平均每个人的停留时间是Ma 秒</li>
</ul>
<p>那么每次发送给服务器的坐标数据R 和总发送数据Ra分别是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">R = 4*M*F*P</span><br><span class="line">Ra = 4*Ma*F*P</span><br><span class="line">// 若</span><br><span class="line">M= 2</span><br><span class="line">Ma= 10</span><br><span class="line">F = 60</span><br><span class="line">S = 4</span><br><span class="line">// 则</span><br><span class="line">R = 4*2*60*P = 480（字符）*P</span><br><span class="line">Ra = 4*10*60*P = 2400（字符）*P</span><br></pre></td></tr></table></figure>
<h3 id="优化F"><a href="#优化F" class="headerlink" title="优化F"></a>优化F</h3><p>不管服务器能不能撑住，前端总要先优化一下吧。先从F 入手，作为用户行为分析，不需要高质量电影一般60fps 吧。参考<a href="https://zh.wikipedia.org/wiki/%E5%B8%A7%E7%8E%87" target="_blank" rel="noopener">wiki帧率</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// 如果所看画面之帧率高于每秒约10至12帧的时候，就会认为是连贯的</span><br></pre></td></tr></table></figure></p>
<p>如果我们只是想知道用户的滚动行为，大概知道滚动的过程，那么可以适当压缩到5~10帧。（后面通过一个demo 演示了验证）</p>
<h4 id="优化S-思考一，直接保存坐标"><a href="#优化S-思考一，直接保存坐标" class="headerlink" title="优化S 思考一，直接保存坐标"></a>优化S 思考一，直接保存坐标</h4><p>如果滚动1000px 1001px 1002px 就保存1000,1001,1002 的话，S 需要再加一个分隔符，实际长度是2~5  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2Ma*F*P &lt;= Ra &lt;= 5Ma*F*P</span><br></pre></td></tr></table></figure>
<h4 id="优化S-思考二，合并相同值，规范数据位和重复标记位的bit-长度"><a href="#优化S-思考二，合并相同值，规范数据位和重复标记位的bit-长度" class="headerlink" title="优化S 思考二，合并相同值，规范数据位和重复标记位的bit 长度"></a>优化S 思考二，合并相同值，规范数据位和重复标记位的bit 长度</h4><p>实际上，我们只用到0~1000，所以1001~1023可以当作0~22来使用，这样做的好处是，可以统一用5个bit 来保存数据并区分坐标值和重复标记位的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Ma*F+1+3)*P &lt;= Ra &lt;= (2*Ma*F+1)*P</span><br></pre></td></tr></table></figure>
<h4 id="优化S-思考三，二进制重新编码压缩"><a href="#优化S-思考三，二进制重新编码压缩" class="headerlink" title="优化S 思考三，二进制重新编码压缩"></a>优化S 思考三，二进制重新编码压缩</h4><p>原来记录’999’ 用了3个btye，现在用String.fromCharCode(parseInt(‘1111100111’,2)) 记录，只用了1.25 btye 就够了，差不多压缩了60%</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var numberArray = [&apos;0101&apos;,&apos;0102&apos;,&apos;999&apos;,1002&apos;] // 代表坐标101px 102px 999px 999px 999px </span><br><span class="line">var binaryArray = numberArray.map(n=&gt;&#123;</span><br><span class="line">  var r = n.toString(2)</span><br><span class="line">  while(r.length&lt;10)&#123;// 补足到10bit</span><br><span class="line">    r = &apos;0&apos; + r;</span><br><span class="line">  &#125;</span><br><span class="line">  return r</span><br><span class="line">  &#125;)</span><br><span class="line">var binaryA = binaryArray.join(&apos;&apos;).slice(0,8)</span><br><span class="line">var binaryString = String.fromCharCode(parseInt(binaryA,2)) // binaryString 将为是一个乱码的字符（不知道定位到哪里的Unicode 编码）</span><br></pre></td></tr></table></figure>
<h4 id="综上"><a href="#综上" class="headerlink" title="综上"></a>综上</h4><p>写了个简易压缩demo（<a href="http://pasico.cn/numberbinary" target="_blank" rel="noopener">点这里</a>），可以得出压缩比</p>
<h3 id="github"><a href="#github" class="headerlink" title="github"></a>github</h3><p><a href="https://github.com/pasicopan/numberbinary" target="_blank" rel="noopener">github</a></p>

      
      <h3>原创文章，转载必须声明出处!</h3>
    </div>
    <footer class="article-footer">
      <a data-url="http://paisco.cn/2019/02/18/compress-scroll-data.html" data-id="cjvejigzh0008z4uigy380l5x" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/算法-优化/">算法 优化</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react-quill-image-uploader" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/28/react-quill-image-uploader.html" class="article-date">
  <time datetime="2018-12-28T10:52:13.000Z" itemprop="datePublished">2018-12-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/28/react-quill-image-uploader.html">react-quill-image-uploader</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>a plugin for react-quill which can upload multi image and remember the image url histroy</p>
<img src="/2018/12/28/react-quill-image-uploader/screenshot.jpg" title="screenshot">
<p>github: <a href="https://github.com/pasicopan/react-quill-image-uploader" target="_blank" rel="noopener">https://github.com/pasicopan/react-quill-image-uploader</a></p>
<ul>
<li>click or drag an image into “click or drag” area, then plugin will call uploadCallback and wait for the promise</li>
<li>plugin will remember the image url which is saved</li>
<li>click the image preview, the plugin will insert the image(width=100%) into the editor</li>
<li>drag the toolbar of the plugin and move where you want</li>
</ul>
<h1 id="how-to-install"><a href="#how-to-install" class="headerlink" title="how to install"></a>how to install</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i react-quill-image-uploader</span><br><span class="line"><span class="comment">// yarn add react-quill-image-uploader</span></span><br></pre></td></tr></table></figure>
<h1 id="how-to-use"><a href="#how-to-use" class="headerlink" title="how to use"></a>how to use</h1><p>demo: ./demo/index.html <a href="https://github.com/pasicopan/react-quill-image-uploader/blob/dev/demo/index.html" title="Demo" target="_blank" rel="noopener">Demo</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ReactQuill <span class="keyword">from</span> <span class="string">'react-quill'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'react-quill/dist/quill.snow.css'</span></span><br><span class="line"><span class="keyword">import</span> ReactQuillImageUploader,&#123;saveImageSrc&#125; <span class="keyword">from</span> <span class="string">'react-quill-image-uploader'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  modules = &#123;</span><br><span class="line">    toolbar: &#123;</span><br><span class="line">       container: [</span><br><span class="line">        [ <span class="string">'bold'</span>, <span class="string">'italic'</span>, <span class="string">'underline'</span>, <span class="string">'strike'</span> ],</span><br><span class="line">        [ <span class="string">'image'</span> ]</span><br><span class="line">      ],</span><br><span class="line">      handlers: &#123;</span><br><span class="line">        <span class="string">'image'</span>: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123;clientX,<span class="attr">y</span>:clientY &#125; = <span class="built_in">window</span>.event</span><br><span class="line">          <span class="keyword">const</span> position = &#123;<span class="attr">x</span>:clientX,<span class="attr">y</span>:clientY&#125;<span class="comment">// position the plugin to show</span></span><br><span class="line">          <span class="keyword">this</span>.ReactQuillImageUploaderRef &amp;&amp; <span class="keyword">this</span>.ReactQuillImageUploaderRef.toggle(position) <span class="comment">// show or hide the plugin</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  componentDidMount () &#123;</span><br><span class="line">		<span class="keyword">this</span>.quill = <span class="keyword">this</span>.quillRef &amp;&amp; <span class="keyword">this</span>.quillRef.getEditor()</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">quill</span>: <span class="keyword">this</span>.quill &#125;)</span><br><span class="line">    <span class="comment">// import &#123;saveImageSrc&#125; from 'react-quill-image-uploader', call saveImageSrc('https://iph.href.lu/100x100')</span></span><br><span class="line">    <span class="comment">// or</span></span><br><span class="line">    <span class="comment">// &lt;script&gt; call </span></span><br><span class="line">    ReactQuillImageUploader.saveImageSrc(<span class="string">'https://iph.href.lu/100x100'</span>) <span class="comment">// save image url to plugin history manually</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; modules, className = <span class="string">''</span>, placeholder = <span class="string">'write here..'</span> &#125; = <span class="keyword">this</span>.props</span><br><span class="line">    <span class="keyword">const</span> &#123; quill=&#123;&#125; &#125; = <span class="keyword">this</span>.state</span><br><span class="line">    <span class="keyword">return</span> (&lt;div&gt;</span><br><span class="line">      &lt;ReactQuill</span><br><span class="line">        ref=&#123;(el) =&gt; &#123; this.quillRef = el; &#125;&#125;</span><br><span class="line">        placeholder=&#123;placeholder&#125;</span><br><span class="line">        modules=&#123;modules || this.modules&#125;</span><br><span class="line">        className=&#123;className&#125;/&gt;</span><br><span class="line">      &lt;ReactQuillImageUploader ref=&#123;(el) =&gt; &#123; this.ReactQuillImageUploaderRef = el &#125;&#125; quill=&#123;this.state.quill&#125; uploadCallback=&#123;uploadImageCallBack&#125; /&gt;</span><br><span class="line">    &lt;/div&gt;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">async function uploadImageCallBack (file) &#123;</span><br><span class="line">  // post file</span><br><span class="line">  return Promise.resolve(&#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">      link:'https://iph.href.lu/200x200'</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
      <h3>原创文章，转载必须声明出处!</h3>
    </div>
    <footer class="article-footer">
      <a data-url="http://paisco.cn/2018/12/28/react-quill-image-uploader.html" data-id="cjvejigzm000dz4uimqsc9ofe" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/quill/">quill</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-a-login-feature" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/19/a-login-feature.html" class="article-date">
  <time datetime="2018-12-19T08:08:43.000Z" itemprop="datePublished">2018-12-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/19/a-login-feature.html">a login feature</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文来自于一个“自动保存” 的产品需求</p>
<h2 id="交代一下背景"><a href="#交代一下背景" class="headerlink" title="交代一下背景"></a>交代一下背景</h2><ul>
<li>一个后端的系统M 里面，有一个包含富文本编辑器的页面A。</li>
<li>系统M 过一段时间就会登录失效，失效后点击保存文章就会跳转到登录界面，之前还在编辑中的内容就会丢失。</li>
<li>产品提需求，希望有自动保存功能，就像一般的邮箱那样，过一段时间就自动保存。即使登录过期，也不至于丢失全部内容。</li>
</ul>
<h2 id="认真分析一下"><a href="#认真分析一下" class="headerlink" title="认真分析一下"></a>认真分析一下</h2><ul>
<li>页面A 除了富文本编辑器外，还有几个（必填）填空的。已有的后端接口却只能接受字段齐全的post 请求。导致前端不能只提交富文本的内容。</li>
<li>这次产品提的需求，后端没有人配合修改。</li>
<li>产品建议在页面A 加提示，提示用户尽快把（必填）的填空都尽早填了。否则自动保存失败也没办法了。</li>
</ul>
<h2 id="按照产品的思路，工作量也不少，甚至不少坑"><a href="#按照产品的思路，工作量也不少，甚至不少坑" class="headerlink" title="按照产品的思路，工作量也不少，甚至不少坑"></a>按照产品的思路，工作量也不少，甚至不少坑</h2><ul>
<li>首先是要加“进入页面”的提示，一进来就弹窗，或者哪里闪一下，很影响体验。</li>
<li>现在只是页面A，如果以后有页面BCDEFG 呢？都要加提示的话，非常麻烦。</li>
<li>用户提这个需求，可以猜想到是那种写一篇文章需要几十分钟的情况，每两分钟保存一次，挺浪费网络资源的。</li>
<li>方案的结果，还不能保证可以保存最新的内容，痛心。</li>
<li>自动保存失败，还会导致马上跳转登录界面，想象一下，用户写着写着文章，突然自动保存失败，突然跳转登录界面，多难受。</li>
</ul>
<h2 id="再认真分析一下"><a href="#再认真分析一下" class="headerlink" title="再认真分析一下"></a>再认真分析一下</h2><ul>
<li>有没有更通用的方法呢，既不需要改动后端接口，又不加入多余的（提示）代码？</li>
<li>如果使用本地缓存的话，可以避免以上提到的大部分问题，但又引入了新的问题。</li>
<li><ul>
<li>本地缓存数据庞大，一篇文章少说也有上千字，还有图片等。</li>
</ul>
</li>
<li><ul>
<li>基于本地缓存，需要做一个管理类B，定时保存本地，post 保存成功就清除本地数据。</li>
</ul>
</li>
<li><ul>
<li>基于文章id 区分每一条文章数据，甚至还要基于登录用户做区分，数据量进一步扩大。</li>
</ul>
</li>
<li><ul>
<li>不同的页面可能有不同命名的文章id（articleid，pageid，contentid等），管理类B 还需要做个接口，允许每个接入的页面传入具体的文章id。</li>
</ul>
</li>
<li><ul>
<li>性价比不高，没兴趣考虑下去了。。。</li>
</ul>
</li>
</ul>
<h2 id="再再认真分析一下"><a href="#再再认真分析一下" class="headerlink" title="再再认真分析一下"></a>再再认真分析一下</h2><ul>
<li>是时候跳出产品的思维了，产品要搞自动保存，其实是因为登录过期导致丢失了之前编辑的内容。</li>
<li>如果有个办法能够解决“不丢失”，就不用搞自动保存。</li>
<li>如果不跳转登录界面，就可以解决“不丢失”。</li>
<li><ul>
<li>思路清晰了很多，如果把现在的登录过期强制跳转去掉，改为提示用户“请另开一个浏览器窗口，登录系统M ，然后回来点保存”，工作量基本为0了。</li>
</ul>
</li>
<li>作为一个有经验（踩坑多）的程序员，估计我们尊贵的用户是看不懂，不会操作的。</li>
</ul>
<h2 id="新思路"><a href="#新思路" class="headerlink" title="新思路"></a>新思路</h2><ul>
<li>弹窗方式打开登录界面，登录成功自动关闭，估计很多人已经在其他网站见识过了，例如qq 空间。</li>
<li>这思路比之前的都要好，没有刚才提到的任何问题，足够抽象，不需要改动现有的业务代码，又能全系统共用。</li>
<li>不同的是qq 空间是有专门的登录接口的，而我们的登录系统并没有给到独立的接口，甚至系统M 和登录系统的域名都不一样。</li>
</ul>
<img src="/2018/12/19/a-login-feature/qzone.jpg" title="qq 空间">
<h2 id="新方案"><a href="#新方案" class="headerlink" title="新方案"></a>新方案</h2><ul>
<li>变通的方法还是有的，可以通过新建iframe 打开登录系统</li>
<li>iframe 登录成功自动跳转回到系统M 的时候，设置window.name = ‘login’</li>
<li>外层的系统M 通过轮询iframe.contentWindow.name 判断iframe 是否成功登录（更新登录session）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateLoginSession</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> loginFrame = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>)</span><br><span class="line">    <span class="comment">// css</span></span><br><span class="line">    <span class="comment">// append to body</span></span><br><span class="line">    <span class="keyword">const</span> timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> loginFrameName = <span class="string">''</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        loginFrameName = loginFrame.contentWindow.name <span class="comment">// iframe 打开其他域名的网站的时候，因为跨越限制，读不了name 的</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'waiting for login redirect'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (loginFrameName === <span class="string">'login'</span>) &#123;</span><br><span class="line">        <span class="comment">// remove iframe from body</span></span><br><span class="line">        <span class="comment">// update session success callback</span></span><br><span class="line">        resolve()</span><br><span class="line">        timer &amp;&amp; clearInterval(timer)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><ul>
<li>现在是已经可以“不丢失”了，但用户需要重新点一下保存按钮。另外，例如页面B 是显示一个列表，进入页面B 的时候因为登录过期而“弹出登录iframe”，即使成功刷新了登录session，但这时候的页面B 发出的请求已经出错，列表也不能正常显示。</li>
<li>接下来的优化思路就是拦截下原来的出错请求，等待新的session 后，才resolve，保证了原来的业务代码能够收到正常的response</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> isShowSessionOutDateModal = <span class="literal">false</span> <span class="comment">// 保证只弹一次警告窗</span></span><br><span class="line"><span class="keyword">const</span> sessionOutDateRequestConfigList = [] <span class="comment">// 保存全部因为session 过期导致请求失败的request</span></span><br><span class="line"></span><br><span class="line">axios.interceptors.response.use(<span class="function"><span class="keyword">function</span> (<span class="params">&#123; data, config, status, request &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (data.code === <span class="number">200</span>) &#123;</span><br><span class="line">    <span class="comment">// normal</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.code === <span class="number">12345</span>) &#123;<span class="comment">// session 过期</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      sessionOutDateRequestConfigList.push(&#123; config, resolve &#125;)</span><br><span class="line">      <span class="keyword">if</span> (!isShowSessionOutDateModal) &#123;</span><br><span class="line">        isShowSessionOutDateModal = <span class="literal">true</span></span><br><span class="line">        Modal.error(&#123;</span><br><span class="line">          title: <span class="string">'登录已过期'</span>,</span><br><span class="line">          content: <span class="string">'用户会话过期'</span>,</span><br><span class="line">          okText: <span class="string">'确定'</span>,</span><br><span class="line">          maskClosable: <span class="literal">false</span>,</span><br><span class="line">          onOk () &#123;</span><br><span class="line">            isShowSessionOutDateModal = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="comment">/* 如果是首次打开系统M 就session 过期，还是老老实实跳转到登录系统吧 */</span>) &#123;</span><br><span class="line">              <span class="built_in">window</span>.location.href = data.data.loginURL <span class="comment">// 登录系统地址</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              util.updateLoginSession(data.data.loginURL).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 避免retry request 的时候死循环</span></span><br><span class="line">                <span class="keyword">const</span> retryList = []</span><br><span class="line">                <span class="keyword">while</span> (sessionOutDateRequestConfigList.length) &#123;</span><br><span class="line">                  retryList.push(sessionOutDateRequestConfigList.pop())</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (retryList.length) &#123;</span><br><span class="line">                  <span class="keyword">const</span> &#123; <span class="attr">config</span>: retryConfig, <span class="attr">resolve</span>: retryResolve &#125; = retryList.pop()</span><br><span class="line">                  <span class="comment">// 重新发出请求</span></span><br><span class="line">                  axios(retryConfig).then(retryResolve)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>结论，认真分析需求，程序员好，产品好，测试好，大家好！</p>
<p>全文完。</p>

      
      <h3>原创文章，转载必须声明出处!</h3>
    </div>
    <footer class="article-footer">
      <a data-url="http://paisco.cn/2018/12/19/a-login-feature.html" data-id="cjvejigze0004z4ui0bj13fy6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/业务思考/">业务思考</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sad-for-NaN" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/07/sad-for-NaN.html" class="article-date">
  <time datetime="2018-11-07T02:37:24.000Z" itemprop="datePublished">2018-11-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/07/sad-for-NaN.html">一个key=&#34;NaN&#34; 引发的血案</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>先回到现场，代码如下。因为component0 会传入不同的questionData，而切换的时候并不会更新component0 内部的私有状态select。为了解决这个问题，我在container 加了:key=”containerKey”。</p>
<h3 id="container-html"><a href="#container-html" class="headerlink" title="container html"></a>container html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"container"</span> <span class="attr">:key</span>=<span class="string">"containerKey"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"component0"</span> <span class="attr">:questionData</span>=<span class="string">"questionData"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"component1"</span> &#123; <span class="attr">bottom:</span> <span class="attr">this.isFixBottom</span> ? "<span class="attr">68px</span>" <span class="attr">:</span> "<span class="attr">0</span>" &#125;&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="container-javascript"><a href="#container-javascript" class="headerlink" title="container javascript"></a>container javascript</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [&#123;<span class="attr">id</span>:<span class="number">1</span>, <span class="attr">title</span>:<span class="string">'title1'</span>, <span class="attr">select</span>:<span class="string">''</span>&#125;, &#123;<span class="attr">title</span>:<span class="string">'title2'</span>, <span class="attr">select</span>:<span class="string">''</span>&#125;]</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  computed:&#123;</span><br><span class="line">    containerKey()&#123;<span class="keyword">return</span> <span class="built_in">Number</span>(<span class="keyword">this</span>.questionData.id)&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  data: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      questionData:arr[<span class="number">0</span>],</span><br><span class="line">      isFixBottom: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="component0-html"><a href="#component0-html" class="headerlink" title="component0 html"></a>component0 html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"component0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123;title&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> @<span class="attr">click</span>=<span class="string">"selectA"</span>&gt;</span>A<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> @<span class="attr">click</span>=<span class="string">"selectB"</span>&gt;</span>B<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="component0-javascript"><a href="#component0-javascript" class="headerlink" title="component0 javascript"></a>component0 javascript</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  props:[<span class="string">'questionData'</span>]</span><br><span class="line">  data: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      selected:<span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    selectA()&#123;<span class="keyword">this</span>.selected=<span class="string">'A'</span>&#125;,</span><br><span class="line">    selectB()&#123;<span class="keyword">this</span>.selected=<span class="string">'B'</span>&#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="接下来就是奇怪的事情了，当我修改container-的isFixBottom-的时候，component0-自己重新mount-了一次。"><a href="#接下来就是奇怪的事情了，当我修改container-的isFixBottom-的时候，component0-自己重新mount-了一次。" class="headerlink" title="接下来就是奇怪的事情了，当我修改container 的isFixBottom 的时候，component0 自己重新mount 了一次。"></a>接下来就是奇怪的事情了，当我修改container 的isFixBottom 的时候，component0 自己重新mount 了一次。</h3><p>而当我把:key=”containerKey” ,改为 :key=”<code>abc${containerKey}</code>“ 后就没有问题。百思不得其解后，开始查看chrome 调试器，通过在mount 设置断点，再查看call stack，很快在patch 函数里面看到了两种写法的区别。</p>
<ul>
<li>:key=”containerKey” 的时候，走到了patchVnode</li>
<li>:key=”<code>abc${containerKey}</code>“ 的时候，没有走到patchVnode</li>
</ul>
<p>同时发现，我传的containerKey 竟然是NaN。到这里，已经让人想起那张经典的JS 吐槽图了。</p>
<img src="/2018/11/07/sad-for-NaN/nan0.jpg" title="call stack">
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span> (<span class="params">oldVnode, vnode, hydrating, removeOnly, parentElm, refElm</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isUndef(vnode)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isDef(oldVnode)) &#123; invokeDestroyHook(oldVnode); &#125;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> isInitialPatch = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> insertedVnodeQueue = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isUndef(oldVnode)) &#123;</span><br><span class="line">      <span class="comment">// empty mount (likely as component), create new root element</span></span><br><span class="line">      isInitialPatch = <span class="literal">true</span>;</span><br><span class="line">      createElm(vnode, insertedVnodeQueue, parentElm, refElm);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> isRealElement = isDef(oldVnode.nodeType);</span><br><span class="line">      <span class="keyword">if</span> (!isRealElement &amp;&amp; sameVnode(oldVnode, vnode)) &#123;</span><br><span class="line">        <span class="comment">// patch existing root node</span></span><br><span class="line">        patchVnode(oldVnode, vnode, insertedVnodeQueue, removeOnly);<span class="comment">// :key="containerKey"</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// :key="abc$&#123;containerKey&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch);</span><br><span class="line">    <span class="keyword">return</span> vnode.elm</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看看sameVnode 的定义，再log 一下NaN===NaN，终于真相大白了。<br>因为我不小心把NaN 传到了key 里面，而NaN永远不等于NaN，导致vue 认为现在的container 不是旧的container，然后重新mount container 的children。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sameVnode</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    a.key === b.key &amp;&amp; (</span><br><span class="line">      (</span><br><span class="line">        a.tag === b.tag &amp;&amp;</span><br><span class="line">        a.isComment === b.isComment &amp;&amp;</span><br><span class="line">        isDef(a.data) === isDef(b.data) &amp;&amp;</span><br><span class="line">        sameInputType(a, b)</span><br><span class="line">      ) || (</span><br><span class="line">        isTrue(a.isAsyncPlaceholder) &amp;&amp;</span><br><span class="line">        a.asyncFactory === b.asyncFactory &amp;&amp;</span><br><span class="line">        isUndef(b.asyncFactory.error)</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="literal">NaN</span>===<span class="literal">NaN</span>) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<p>总结就是，认真看call stack，不要浪费太多时间在一些表面的现象上找规律</p>

      
      <h3>原创文章，转载必须声明出处!</h3>
    </div>
    <footer class="article-footer">
      <a data-url="http://paisco.cn/2018/11/07/sad-for-NaN.html" data-id="cjvejigzp000ez4uiubbfhuyn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mistake/">mistake</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-miniprogram-swiper-effect" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/15/miniprogram-swiper-effect.html" class="article-date">
  <time datetime="2018-08-15T10:22:54.000Z" itemprop="datePublished">2018-08-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/15/miniprogram-swiper-effect.html">微信小程序 swiper 效果</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天在小程序上实现一个 swiper 的效果，先看最终效果</p>
<img src="/2018/08/15/miniprogram-swiper-effect/ef1.gif" title="最终效果">
<p><center>（图 1）</center><br><br><br><br></p>
<h3 id="约定说明"><a href="#约定说明" class="headerlink" title="约定说明"></a>约定说明</h3><p>先说明一下：</p>
<ul>
<li>基于 windows 微信开发工具 v1.02.1808101</li>
<li>图片之间，和左右两端的间距都是 15</li>
<li>屏幕宽度约定是 750</li>
<li>显示前两张图的时候，右边的图露出一点</li>
<li>显示最后一张图，是左边的图漏出一点</li>
</ul>
<p>前两张图的效果没什么好说的了，使用 swiper 组件，配置左右 margin 是 15<br>然后呢？！<br>然后也很简单</p>
<h3 id="重点第三张图"><a href="#重点第三张图" class="headerlink" title="重点第三张图"></a>重点第三张图</h3><p>绑定 change 事件，当滑动到最后一页的时候，把图片 style={left:15;position:relative;} 或者加上同等效果的 class。<br>大功告成！<br>GOD？！为什么这么改就可以了呢？接下来是正戏了</p>
<h3 id="内部分析"><a href="#内部分析" class="headerlink" title="内部分析"></a>内部分析</h3><p>首先我们要明白小程序的 swiper 是怎么实现的，（跳过 nwjs 和 shadowdom 部分），可以找到一些信息：</p>
<img src="/2018/08/15/miniprogram-swiper-effect/wechattest0.jpg" title="内部分析">
<p><center>（图 2：显示第一张图）</center><br><br><br><br><br><img src="/2018/08/15/miniprogram-swiper-effect/wechattest1.jpg" title="内部分析"></p>
<p><center>（图 3：显示第二张图）</center><br><br><br><br><br><img src="/2018/08/15/miniprogram-swiper-effect/wechattest2.jpg" title="内部分析"></p>
<p><center>（图 4：显示最后一张图）</center><br><br><br><br><br><img src="/2018/08/15/miniprogram-swiper-effect/margin.jpg" title="内部分析"></p>
<p><center>（图 5）</center><br><br><br><br></p>
<ul>
<li>.wx-swiper-sliders 使用 translate(0) translate(-100%) translate(-200%) 执行滑动</li>
<li>（如果 .swiper-item 使用了!important 修改宽度样式，这里会重新计算。例如现在.swiper-item width应该是375-15-15=340，如果设置.swiper-item{width:306}，那么.wx-swiper-sliders 将会translate(0) translate(-90%) translate(-180%) 这样移动）</li>
<li>外部定义的 previous-margin 和 next-margin ，水平方向上，只是作用于.wx-swiper-sliders 的 left 和 right，也等于同时设置了.swiper-item width=375-15-15</li>
<li>每个.wx-swiper-item 的布局是使用 translate(0) translate(100%) translate(200%) 作为相对偏移</li>
</ul>
<h3 id="再次看看第三张图"><a href="#再次看看第三张图" class="headerlink" title="再次看看第三张图"></a>再次看看第三张图</h3><p>如果没有之前绑定 change 事件的操作，那么第三张图应该是像前两张图那样显示的，有了 change 事件后，第二第三张图就会右移 15，变成了我们的最终效果</p>
<h3 id="修改-previous-margin-会怎样？"><a href="#修改-previous-margin-会怎样？" class="headerlink" title="修改 previous-margin 会怎样？"></a>修改 previous-margin 会怎样？</h3><p>如果修改 previous-margin，从 15 改到 30，理论上也是能 达到相同的效果的，但但但，丝滑般的滑动就没有了。<br>为什么呢？<br>继续看看代码。<br><img src="/2018/08/15/miniprogram-swiper-effect/marginPro.jpg" title="内部分析"></p>
<p><center>（图 6：修改margin 触发重置布局）</center><br><br><br><img src="/2018/08/15/miniprogram-swiper-effect/resetlayout.jpg" title="内部分析"></p>
<p><center>（图 7：重置布局，触发结束动画）</center><br><br><br><img src="/2018/08/15/miniprogram-swiper-effect/endanimation.jpg" title="内部分析"></p>
<p><center>（图 8：结束动画）</center><br><br></p>
<ul>
<li>修改 margin 触发重置布局</li>
<li>重置布局，触发结束动画</li>
<li>结束动画，删掉动画过程，直接瞬移到动画结束状态（没有了丝滑的移动效果了）</li>
</ul>
<p>全文完。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://developers.weixin.qq.com/miniprogram/dev/component/swiper.html" title="小程序组件swiper" target="_blank" rel="noopener">小程序组件 swiper</a></li>
<li><a href="https://aotu.io/notes/2016/06/24/Shadow-DOM/index.html" title="神奇的Shadow DOM" target="_blank" rel="noopener">神奇的 Shadow DOM</a></li>
<li><a href="http://docs.nwjs.io/en/latest/References/Window/#windowopenurl-options-callback" title="nwjs document" target="_blank" rel="noopener">nwjs document</a></li>
<li><a href="https://stackoverflow.com/questions/12583545/debugging-new-chrome-packaged-apps" title="debugging-new-chrome-packaged-apps" target="_blank" rel="noopener">debugging-new-chrome-packaged-apps</a></li>
</ul>

      
      <h3>原创文章，转载必须声明出处!</h3>
    </div>
    <footer class="article-footer">
      <a data-url="http://paisco.cn/2018/08/15/miniprogram-swiper-effect.html" data-id="cjvejigzl000az4uigrmrdwic" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-an-idea-about-build-vue-without-webpack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/12/an-idea-about-build-vue-without-webpack.html" class="article-date">
  <time datetime="2018-07-12T07:42:10.000Z" itemprop="datePublished">2018-07-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/12/an-idea-about-build-vue-without-webpack.html">an-idea-about-build-vue-without-webpack</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一些想法，服务器编译vue-项目的最低消耗"><a href="#一些想法，服务器编译vue-项目的最低消耗" class="headerlink" title="一些想法，服务器编译vue 项目的最低消耗"></a>一些想法，服务器编译vue 项目的最低消耗</h2><h3 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h3><ul>
<li>需要生成vue 项目，有Babel ,css scoped style 特性</li>
<li>平台项目相对稳定，开放给第三方开发插件</li>
<li>平台作为编辑器，组合各个插件生成一个vue 项目，但避免每次生成都需要(webpack)编译</li>
</ul>
<h3 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h3><ul>
<li>有这么一个后台编辑器，通过拖拽把banner，信息流，tabbar 等插件拉到同一个界面，然后可以导出网页</li>
<li>现在，banner ，信息流，tabbar 这些组件交给第三方去开发</li>
<li>组合出来的网页，不会使用webpack 进行再次编译</li>
</ul>
<h3 id="想法一-修改本地webpack-编译vue-文件，导出js-文件，上传给平台使用"><a href="#想法一-修改本地webpack-编译vue-文件，导出js-文件，上传给平台使用" class="headerlink" title="想法一 修改本地webpack 编译vue 文件，导出js 文件，上传给平台使用"></a>想法一 修改本地webpack 编译vue 文件，导出js 文件，上传给平台使用</h3><p>参考webpack 的打包方案，如果可以把每个vue （插件）文件都打包成一个chunk，上传给平台，那么平台指需要重写“路由”，“引用”和“文件” 三个地方的 chunk id，其他功能就可以沿用下来，绕开了编译过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">以下例子全部基于vue cli 3.0 初始化的demo 项目</span><br></pre></td></tr></table></figure>
<h4 id="首先，获取插件chunk-的文件名"><a href="#首先，获取插件chunk-的文件名" class="headerlink" title="首先，获取插件chunk 的文件名"></a>首先，获取插件chunk 的文件名</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以通过设置webpackChunkName </span></span><br><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="comment">// import App from('./App.vue') 替换为 const App = () =&gt; import (/* webpackChunkName: 'App' */'./App.vue')</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// build 出来的chunk 文件将会从0.b0781257.js 替换为App.b0781257.js</span></span><br><span class="line"><span class="comment">// dist/js/</span></span><br><span class="line"><span class="comment">//         - 0.b0781257.js</span></span><br><span class="line"><span class="comment">//         + App.b0781257.js</span></span><br></pre></td></tr></table></figure>
<h4 id="有了文件名，就要开始重写路由"><a href="#有了文件名，就要开始重写路由" class="headerlink" title="有了文件名，就要开始重写路由"></a>有了文件名，就要开始重写路由</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分析app.xxx.js 文件，路由包含&#123; 0: "App", 2: "HelloWorld" &#125; 和&#123; 0: "b0781257", 2: "d6560d55" &#125; </span></span><br><span class="line">这里<span class="number">0</span> 对应App，<span class="number">2</span> 对应HelloWorld，那么路由就能以这种格式，自己任意拓展了</span><br><span class="line">c.charset = <span class="string">"utf-8"</span>, </span><br><span class="line">c.timeout = <span class="number">120</span>, </span><br><span class="line">i.nc &amp;&amp; c.setAttribute(<span class="string">"nonce"</span>, i.nc), </span><br><span class="line">c.src = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123; </span><br><span class="line">  <span class="keyword">return</span> i.p + <span class="string">"js/"</span> + (&#123; <span class="number">0</span>: <span class="string">"App"</span>, <span class="number">2</span>: <span class="string">"HelloWorld"</span> &#125;[e] || e) + <span class="string">"."</span> + &#123; <span class="number">0</span>: <span class="string">"b0781257"</span>, <span class="number">2</span>: <span class="string">"d6560d55"</span> &#125;[e] + <span class="string">".js"</span> &#125;(e), </span><br><span class="line">  u = <span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br></pre></td></tr></table></figure>
<h4 id="接下来是组件内的引用"><a href="#接下来是组件内的引用" class="headerlink" title="接下来是组件内的引用"></a>接下来是组件内的引用</h4><p>例如这里引用了module id=0 的模块，并绑定了传入了Pf3K 参数<br>Pf3K 对应的是App.xxx.js 这个chunk 里面的一个初始化vue 模板的方法<br>我们处理上传的插件的时候，需要把module id 转换成有效的module id，也就是平台上已经稳定的module id<br>我们可以通过修改webpack output filename 的设置，例如上面打包出来的App.xx.js 模块，加入module id 的信息，变成App.0.xx.js，这样子就可以得到一个映射</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js (编译钱对应main.js)</span></span><br><span class="line"><span class="keyword">var</span> n = r(<span class="string">"Kw5r"</span>),</span><br><span class="line">o = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">  <span class="keyword">return</span> r.e(<span class="number">0</span>).then(r.bind(<span class="literal">null</span>, <span class="string">"Pf3K"</span>)) <span class="comment">// 引用了App.vue 模块，也就是引用了App.0.xx.js 这个文件</span></span><br><span class="line">  &#125;;</span><br><span class="line">n.a.config.productionTip = !<span class="number">1</span>, <span class="keyword">new</span> n.a(&#123; <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123; <span class="keyword">return</span> e(o) &#125; &#125;).$mount(<span class="string">"#app"</span>)</span><br></pre></td></tr></table></figure>
<p>根据以上的映射，我们扫描插件代码，替换成平台的module id和bind 参数就可以了</p>
<pre><code class="javascript"><span class="comment">// App.0.xx.js</span>
<span class="comment">// 同理，每个模块的头部有个push，记录了自身引用的module id 数组，把这里也扫描替换掉</span>
(<span class="built_in">window</span>.webpackJsonp = <span class="built_in">window</span>.webpackJsonp || []).push([[<span class="number">0</span>]

</code></pre>
<h3 id="想法二-本地Babel-编译vue-文件的js-部分，自己写css-scoped-style"><a href="#想法二-本地Babel-编译vue-文件的js-部分，自己写css-scoped-style" class="headerlink" title="想法二 本地Babel 编译vue 文件的js 部分，自己写css scoped style"></a>想法二 本地Babel 编译vue 文件的js 部分，自己写css scoped style</h3><p>待续。。。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/mrdulin/blog/issues/43" target="_blank" rel="noopener">https://github.com/mrdulin/blog/issues/43</a></li>
<li><a href="https://github.com/hawx1993/tech-blog/issues/3" target="_blank" rel="noopener">https://github.com/hawx1993/tech-blog/issues/3</a></li>
<li><a href="https://webpack.docschina.org/api/module-methods#import-" target="_blank" rel="noopener">https://webpack.docschina.org/api/module-methods#import-</a> </li>
<li><a href="https://github.com/879479119/879479119.github.io/issues/1" target="_blank" rel="noopener">https://github.com/879479119/879479119.github.io/issues/1</a></li>
</ul>

      
      <h3>原创文章，转载必须声明出处!</h3>
    </div>
    <footer class="article-footer">
      <a data-url="http://paisco.cn/2018/07/12/an-idea-about-build-vue-without-webpack.html" data-id="cjvejigzf0005z4ui8vlnxmae" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  



            </section>
            
              <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/mistake/">mistake</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/quill/">quill</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/业务思考/">业务思考</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法-优化/">算法 优化</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/mistake/" style="font-size: 10px;">mistake</a> <a href="/tags/quill/" style="font-size: 10px;">quill</a> <a href="/tags/react/" style="font-size: 10px;">react</a> <a href="/tags/业务思考/" style="font-size: 10px;">业务思考</a> <a href="/tags/算法-优化/" style="font-size: 10px;">算法 优化</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/05/08/hello-world.html">Hello World</a>
          </li>
        
          <li>
            <a href="/2019/02/18/compress-scroll-data.html">压缩页面滚动坐标的数据</a>
          </li>
        
          <li>
            <a href="/2018/12/28/react-quill-image-uploader.html">react-quill-image-uploader</a>
          </li>
        
          <li>
            <a href="/2018/12/19/a-login-feature.html">a login feature</a>
          </li>
        
          <li>
            <a href="/2018/11/07/sad-for-NaN.html">一个key=&#34;NaN&#34; 引发的血案</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
                
          </div>
          <footer id="footer">
  
        <div class="outer">
          <div id="footer-info" class="inner">
            &copy;
            2019
              pasico
                <br> mail:
                <a href="mailto:pasico@163.com" title="pasico@163.com">pasico@163.com</a>
                  <br>
                  Powered by
                    <a href="http://hexo.io/" target="_blank">Hexo</a>
          </div>
        </div>
          <script src="https://s19.cnzz.com/z_stat.php?id=1271870936&web_id=1271870936" language="JavaScript"></script>
            </span>
</footer>
      </div>
      <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
        

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



    </div>
  </body>

  </html>